<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SUMI — Firmware Flasher</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script type="module" src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--ink:#111;--paper:#f5f0e8;--paper-dark:#e8e0d0;--muted:#777;--border:#ccc;--accent:#8b4513;--success:#2d6a2e;--error:#8b1a1a;
  --font:'Cormorant Garamond',Georgia,serif;--mono:'JetBrains Mono',monospace}
html{scroll-behavior:smooth}
body{font-family:var(--font);background:var(--paper);color:var(--ink);min-height:100vh;line-height:1.6}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  background-repeat:repeat;opacity:0.6}

.header{text-align:center;padding:40px 20px 24px;border-bottom:1px solid var(--border);position:relative}
.header h1{font-size:36px;font-weight:700;letter-spacing:-1px}
.header p{font-style:italic;color:var(--muted);margin-top:4px}
.header .back{position:absolute;left:20px;top:44px;font-family:var(--mono);font-size:12px;text-decoration:none;color:var(--ink);letter-spacing:1px;text-transform:uppercase}

.container{max-width:860px;margin:0 auto;padding:40px 20px}

/* Steps */
.steps{display:grid;grid-template-columns:1fr 1fr 1fr;gap:24px;margin-bottom:48px}
@media(max-width:600px){.steps{grid-template-columns:1fr}}
.step{text-align:center;padding:24px 16px;border:1px solid var(--border)}
.step-num{font-family:var(--mono);font-size:36px;font-weight:700;display:block;margin-bottom:8px;color:var(--accent)}
.step h4{font-size:17px;margin-bottom:4px;font-weight:700}
.step p{font-size:13px;color:var(--muted)}

.tag{display:inline-block;font-family:var(--mono);font-size:10px;letter-spacing:1px;text-transform:uppercase;border:1px solid var(--border);padding:3px 8px;margin-right:4px}

/* Flash section */
.flash-section{border:2px solid var(--ink);padding:40px 32px;text-align:center;margin-bottom:40px;position:relative}
.flash-section::before{content:'FLASH';position:absolute;top:-12px;left:24px;background:var(--paper);padding:0 8px;font-family:var(--mono);font-size:11px;letter-spacing:2px;color:var(--muted)}
.flash-section h3{font-size:24px;margin-bottom:12px}
.flash-section p{color:var(--muted);font-size:14px;margin-bottom:24px}
.flash-section .tags{margin-bottom:20px}

esp-web-install-button{display:inline-block}
esp-web-install-button::part(button){
  font-family:var(--mono);font-size:13px;letter-spacing:1px;text-transform:uppercase;
  padding:14px 32px;border:2px solid var(--ink);background:var(--ink);color:var(--paper);cursor:pointer;transition:all .15s}
esp-web-install-button::part(button):hover{background:transparent;color:var(--ink)}

/* Partition diagram */
.partition-block{font-family:var(--mono);font-size:12px;line-height:1.8;background:var(--ink);color:#e0d8c8;padding:24px;white-space:pre;overflow-x:auto;margin:20px 0}

/* Info boxes */
.info{border:1px solid var(--border);padding:20px;margin-bottom:16px;font-size:14px;line-height:1.6}
.info h4{font-family:var(--mono);font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--accent);margin-bottom:8px}
.info code{font-family:var(--mono);font-size:12px;background:var(--paper-dark);padding:1px 4px}
.info p+p{margin-top:8px}

/* Divider */
.divider{width:100%;height:2px;background:var(--ink);margin:40px auto;max-width:860px;
  mask-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 960 2' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 1 Q240 0 480 1 T960 1' stroke='black' stroke-width='2' fill='none'/%3E%3C/svg%3E")}

/* Recovery section */
.recovery{border:2px solid var(--error);padding:32px;margin-bottom:40px;position:relative}
.recovery::before{content:'RECOVERY';position:absolute;top:-12px;left:24px;background:var(--paper);padding:0 8px;font-family:var(--mono);font-size:11px;letter-spacing:2px;color:var(--error)}
.recovery h3{font-size:22px;margin-bottom:8px}
.recovery>p{color:var(--muted);font-size:14px;margin-bottom:20px}
.recovery-steps{counter-reset:rstep;list-style:none;padding:0;margin:0 0 24px}
.recovery-steps li{counter-increment:rstep;position:relative;padding:14px 16px 14px 56px;border:1px solid var(--border);margin-bottom:8px;font-size:14px;line-height:1.5}
.recovery-steps li::before{content:counter(rstep);position:absolute;left:16px;top:14px;font-family:var(--mono);font-size:18px;font-weight:700;color:var(--accent)}
.recovery-steps li strong{font-weight:700}
.recovery-steps li em{font-style:italic;color:var(--muted);font-size:13px}
.recovery-note{font-family:var(--mono);font-size:11px;color:var(--muted);letter-spacing:0.3px;line-height:1.6;border-top:1px solid var(--border);padding-top:16px;margin-top:8px}
</style>
</head>
<body>

<div class="header">
  <a href="../" class="back">← GitHub</a>
  <h1>Firmware Flasher</h1>
  <p>Flash SUMI directly from your browser via USB</p>
  <a href="#recovery" style="display:inline-block;margin-top:12px;font-family:var(--mono);font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--error);text-decoration:none;border:1px solid var(--error);padding:5px 12px">Device stuck? → Recovery Guide</a>
</div>

<div class="container">

<div class="steps">
  <div class="step"><span class="step-num">1</span><h4>Connect</h4><p>Plug in via USB, hold BOOT during power-on</p></div>
  <div class="step"><span class="step-num">2</span><h4>Flash</h4><p>Click the button below. Takes about 30 seconds.</p></div>
  <div class="step"><span class="step-num">3</span><h4>Done</h4><p>Unplug, insert SD card, and you're reading</p></div>
</div>

<div class="flash-section">
  <h3>Flash SUMI</h3>
  <p>Installs SUMI reader + SumiBoy emulator. Requires Chrome or Edge.</p>
  <div class="tags">
    <span class="tag">v0.4.1</span>
    <span class="tag">SUMI + SumiBoy</span>
    <span class="tag">ESP32-C3</span>
  </div>

  <esp-web-install-button manifest="./manifest-sumi.json">
    <span slot="unsupported">
      <p style="color:var(--error);font-size:14px;margin-bottom:12px">
        Web Serial not supported in this browser.<br>Please use Chrome or Edge.
      </p>
    </span>
    <span slot="not-allowed">
      <p style="color:var(--error);font-size:14px">
        Serial access blocked. Check browser permissions.
      </p>
    </span>
  </esp-web-install-button>

  <p style="margin-top:16px;font-family:var(--mono);font-size:11px;color:var(--accent);letter-spacing:0.5px">
    ⚠ When the install dialog appears, check "Erase device" — this prevents boot issues from stale flash data.
  </p>
</div>

<div class="recovery" id="recovery">
  <h3>Device Recovery</h3>
  <p>If your device is stuck, frozen, boot-looping, or the USB keeps disconnecting and reconnecting — follow these steps. This works even if the flash is completely erased.</p>

  <ol class="recovery-steps">
    <li><strong>Close everything</strong> on your computer that might be using the serial port — browser tabs with flash tools, terminal apps, Arduino IDE, etc. Close them all first.</li>
    <li><strong>Unplug the device</strong> from USB completely.</li>
    <li><strong>Find the BOOT button.</strong> It's the small button hidden underneath the up/down page-turn toggle on the side of the device. It's recessed under the rocker — you may need to use a fingernail or something thin to press it.</li>
    <li><strong>Hold BOOT and plug in USB.</strong> Press and hold the BOOT button, and <em>while still holding it</em>, plug the USB cable into the device. Keep holding BOOT for about 3 seconds after plugging in, then let go.</li>
    <li><strong>Check the connection.</strong> The USB disconnecting/reconnecting should stop. Your device should now appear as one steady serial port.</li>
    <li><strong>Flash SUMI.</strong> Using Chrome or Edge, scroll up to the flash section on this page and click the flash button.</li>
    <li><strong>Check "Erase device"</strong> when the install dialog appears, then click Install. This takes about 30 seconds.</li>
  </ol>

  <esp-web-install-button manifest="./manifest-sumi.json">
    <span slot="unsupported">
      <p style="color:var(--error);font-size:13px">Web Serial not supported — use Chrome or Edge.</p>
    </span>
  </esp-web-install-button>

  <div class="recovery-note">
    <strong>Still not connecting?</strong> Try a different USB cable (some are charge-only and don't carry data). Try plugging directly into your computer, not through a USB hub. If the device is still cycling, try holding BOOT the entire time — don't let go until after you click flash.<br><br>
    <strong>Frozen screen?</strong> E-ink screens hold their last image like real ink — even with no power. The frozen display does NOT mean the device is broken. Once firmware is flashed, the screen will refresh normally.<br><br>
    <strong>Manual recovery:</strong> <code>python -m esptool --chip esp32c3 write_flash 0x0 sumi-full.bin</code>
  </div>
</div>

<div class="info" id="postFlashTip" style="display:none;border-color:var(--success);margin-top:24px;margin-bottom:40px">
  <h4 style="color:var(--success)">✓ You're all set</h4>
  <p><b>Step 1 — Set up your SD card.</b> Download the <a href="../sdcard" style="color:var(--accent);font-weight:600">SD card starter folder</a> from this repo and copy its contents to the root of your SD card. This includes the home screen themes, font data, and the folder structure SUMI expects. Without it, themes and some features won't work.</p>
  <p><b>Step 2 — Add your books.</b> Drop EPUBs, TXT, or Markdown files into the <code>books</code> folder. SUMI will find them wherever you put them, but <code>books</code> keeps things tidy.</p>
  <p><b>Step 3 — Optimize for e-ink.</b> If you've got a library of existing ebooks, run them through the <a href="https://sumi.page/convert/" style="color:var(--accent);font-weight:600">Universal Converter</a> first. Most EPUBs are built for color tablets — oversized images, web fonts, heavy CSS. The converter strips all that down and re-tunes everything for e-ink. Same books, just faster rendering and smaller files.</p>
</div>

<div class="divider"></div>

<div class="info">
  <h4>What Gets Flashed</h4>
  <p>One binary, two firmwares. SUMI goes into app0 (the reader, apps, everything). SumiBoy goes into app1 (Game Boy emulator). They dual-boot — select SumiBoy from the SUMI home screen and the device reboots into emulator mode. Hold POWER for 5 seconds in the emulator to return.</p>
</div>

<div class="info">
  <h4>Flash Layout (16MB)</h4>
  <pre class="partition-block">  ┌──────────────────────────────────────────────────┐
  │ 0x0000   Bootloader          (16KB)              │
  │ 0x8000   Partition Table     (4KB)               │
  │ 0x9000   NVS                 (20KB)              │
  │ 0xE000   OTA Data            (8KB)               │
  ├──────────────────────────────────────────────────┤
  │ 0x10000  app0: SUMI          (6.25MB)  ← Reader │
  ├──────────────────────────────────────────────────┤
  │ 0x650000 app1: SumiBoy       (6.25MB)  ← Emu    │
  ├──────────────────────────────────────────────────┤
  │ 0xC90000 SPIFFS              (3.4MB)   ← Data   │
  ├──────────────────────────────────────────────────┤
  │ 0xFF0000 Core Dump           (64KB)              │
  └──────────────────────────────────────────────────┘</pre>
</div>

<div class="info">
  <h4>Troubleshooting</h4>
  <p><b>Device not detected?</b> Hold the BOOT button (under the up/down toggle) while plugging in USB. Release after 3 seconds. The device should appear as a serial port.</p>
  <p><b>Flash failed?</b> Check "Erase device" in the install dialog, then flash again. If issues persist, see the Recovery section above.</p>
  <p><b>Boot loop?</b> SUMI v0.3.3+ has automatic boot loop recovery — if the device reboots 4 times rapidly it forces itself back to SUMI. If you're stuck on older firmware, follow the Recovery steps above.</p>
  <p><b>USB keeps disconnecting?</b> The device has no firmware running. Follow the Recovery steps above — holding BOOT while plugging in puts it in download mode with a stable connection.</p>
  <p><b>Manual flash:</b> <code>python -m esptool --chip esp32c3 write_flash 0x0 sumi-full.bin</code></p>
</div>

</div>

<script>
document.querySelectorAll('esp-web-install-button').forEach(btn => {
  btn.addEventListener('state-changed', (e) => {
    if (e.detail.state === 'FINISHED') {
      const tip = document.getElementById('postFlashTip');
      tip.style.display = '';
      tip.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  });
});
</script>
</body>
</html>
