<div class="app">
  <header class="header">
    <div class="window-controls">
      <div class="window-control close-btn"></div>
      <div class="window-control"></div>
    </div>
    <div class="logo">üìü SUMI</div>
    <div class="header-status">
      <div class="status-badge">
        <span class="status-dot" id="statusDot"></span>
        <span id="headerStatus">Checking...</span>
      </div>
      <span id="headerBattery">üîã --%</span>
    </div>
  </header>
  
  <!-- Connection Mode Banner -->
  <div id="connectionBanner" style="display: none;"></div>
  
  <div class="main">
    <nav class="sidebar" id="sidebar">
      <div class="nav-section">
        <div class="nav-section-title">Setup</div>
        <div class="nav-item" data-page="summary"><span class="nav-icon">üìã</span>My SUMI</div>
        <div class="nav-item" data-page="builder"><span class="nav-icon">üé®</span>Customize</div>
        <div class="nav-item active" data-page="wifi"><span class="nav-icon">üì∂</span>WiFi</div>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Content</div>
        <div class="nav-item" data-page="files"><span class="nav-icon">üìÅ</span>Files</div>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Settings</div>
        <div class="nav-item" data-page="weather"><span class="nav-icon">üå§Ô∏è</span>Weather</div>
        <div class="nav-item" data-page="display"><span class="nav-icon">üñ•Ô∏è</span>Display</div>
        <div class="nav-item" data-page="bluetooth"><span class="nav-icon">‚å®Ô∏è</span>Keyboard</div>
        <div class="nav-item" data-page="power"><span class="nav-icon">üîã</span>Power</div>
        <div class="nav-item" data-page="about"><span class="nav-icon">‚ÑπÔ∏è</span>About</div>
      </div>
    </nav>
    
    <main class="content">
      <!-- ==================== MY SUMI SUMMARY PAGE ==================== -->
      <div class="page" id="page-summary">
        <div class="page-header">
          <h1 class="page-title">My SUMI</h1>
          <p class="page-desc">Your device configuration at a glance</p>
        </div>
        
        <!-- Device Status -->
        <div class="card" style="margin-bottom: 16px;">
          <div class="card-header" style="background: linear-gradient(90deg, #e3f2fd 0%, #bbdefb 100%);">
            <span class="card-title">üìü Device Status</span>
          </div>
          <div class="card-body" id="summaryDevice">
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; text-align: center;">
              <div><div style="font-size: 24px;">üîã</div><div style="font-weight: 600;" id="sumBattery">--%</div><div style="font-size: 11px; color: #666;">Battery</div></div>
              <div><div style="font-size: 24px;">üíæ</div><div style="font-weight: 600;" id="sumStorage">--</div><div style="font-size: 11px; color: #666;">Storage</div></div>
              <div><div style="font-size: 24px;">üß†</div><div style="font-weight: 600;" id="sumMemory">--</div><div style="font-size: 11px; color: #666;">Free RAM</div></div>
              <div><div style="font-size: 24px;">‚è±Ô∏è</div><div style="font-weight: 600;" id="sumUptime">--</div><div style="font-size: 11px; color: #666;">Uptime</div></div>
            </div>
          </div>
        </div>
        
        <!-- Connection & Location -->
        <div class="card" style="margin-bottom: 16px;">
          <div class="card-header" style="background: linear-gradient(90deg, #e8f5e9 0%, #c8e6c9 100%);">
            <span class="card-title">üåê Connection & Location</span>
          </div>
          <div class="card-body" id="summaryConnection">
            <table style="width: 100%; font-size: 12px;">
              <tr><td style="padding: 6px 0; color: #666;">WiFi Network</td><td style="text-align: right; font-weight: 500;" id="sumWifiSSID">Not connected</td></tr>
              <tr><td style="padding: 6px 0; color: #666;">IP Address</td><td style="text-align: right; font-weight: 500;" id="sumWifiIP">--</td></tr>
              <tr><td style="padding: 6px 0; color: #666;">Weather Location</td><td style="text-align: right; font-weight: 500;" id="sumLocation">Not set</td></tr>
              <tr><td style="padding: 6px 0; color: #666;">Timezone</td><td style="text-align: right; font-weight: 500;" id="sumTimezone">--</td></tr>
              <tr><td style="padding: 6px 0; color: #666;">Current Time</td><td style="text-align: right; font-weight: 500;" id="sumTime">--</td></tr>
            </table>
          </div>
        </div>
        
        <!-- SD Card Contents -->
        <div class="card" style="margin-bottom: 16px;">
          <div class="card-header" style="background: linear-gradient(90deg, #fff3e0 0%, #ffe0b2 100%);">
            <span class="card-title">üíæ SD Card Contents</span>
          </div>
          <div class="card-body" id="summaryContent">
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; text-align: center; margin-bottom: 12px;">
              <div style="background: #f8f9fa; padding: 12px 8px; border-radius: 8px;">
                <div style="font-size: 20px;">üìö</div>
                <div style="font-weight: 700; font-size: 18px;" id="sumBooks">0</div>
                <div style="font-size: 10px; color: #666;">Books</div>
              </div>
              <div style="background: #f8f9fa; padding: 12px 8px; border-radius: 8px;">
                <div style="font-size: 20px;">üñºÔ∏è</div>
                <div style="font-weight: 700; font-size: 18px;" id="sumImages">0</div>
                <div style="font-size: 10px; color: #666;">Images</div>
              </div>
              <div style="background: #f8f9fa; padding: 12px 8px; border-radius: 8px;">
                <div style="font-size: 20px;">üó∫Ô∏è</div>
                <div style="font-weight: 700; font-size: 18px;" id="sumMaps">0</div>
                <div style="font-size: 10px; color: #666;">Maps</div>
              </div>
              <div style="background: #f8f9fa; padding: 12px 8px; border-radius: 8px;">
                <div style="font-size: 20px;">üé¥</div>
                <div style="font-weight: 700; font-size: 18px;" id="sumCards">0</div>
                <div style="font-size: 10px; color: #666;">Flashcards</div>
              </div>
              <div style="background: #f8f9fa; padding: 12px 8px; border-radius: 8px;">
                <div style="font-size: 20px;">üìù</div>
                <div style="font-weight: 700; font-size: 18px;" id="sumNotes">0</div>
                <div style="font-size: 10px; color: #666;">Notes</div>
              </div>
            </div>
            <div id="sumBooksStatus" style="background: #e8f5e9; border-radius: 6px; padding: 8px 12px; font-size: 11px; display: none;">
              <span style="color: #2e7d32;">‚úì All books processed and ready</span>
            </div>
          </div>
        </div>
        
        <!-- Home Screen Customization -->
        <div class="card" style="margin-bottom: 16px;">
          <div class="card-header" style="background: linear-gradient(90deg, #f3e5f5 0%, #e1bee7 100%);">
            <span class="card-title">üé® Home Screen</span>
          </div>
          <div class="card-body" id="summaryHomeScreen">
            <table style="width: 100%; font-size: 12px;">
              <tr><td style="padding: 6px 0; color: #666;">Theme</td><td style="text-align: right; font-weight: 500;" id="sumTheme">--</td></tr>
              <tr><td style="padding: 6px 0; color: #666;">Icon Style</td><td style="text-align: right; font-weight: 500;" id="sumIconStyle">--</td></tr>
              <tr><td style="padding: 6px 0; color: #666;">Orientation</td><td style="text-align: right; font-weight: 500;" id="sumOrientation">--</td></tr>
              <tr><td style="padding: 6px 0; color: #666;">Status Bar</td><td style="text-align: right; font-weight: 500;" id="sumStatusBar">--</td></tr>
            </table>
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee;">
              <div style="font-size: 11px; color: #666; margin-bottom: 8px;">Enabled Apps:</div>
              <div id="sumApps" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
            </div>
          </div>
        </div>
        
        <!-- Display & Power Settings -->
        <div class="card" style="margin-bottom: 16px;">
          <div class="card-header" style="background: linear-gradient(90deg, #e0f7fa 0%, #b2ebf2 100%);">
            <span class="card-title">‚öôÔ∏è Settings</span>
          </div>
          <div class="card-body" id="summarySettings">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div>
                <div style="font-size: 11px; color: #666; margin-bottom: 6px; font-weight: 600;">Display</div>
                <table style="width: 100%; font-size: 11px;">
                  <tr><td style="padding: 4px 0; color: #888;">Boot to Last Book</td><td style="text-align: right;" id="sumBootBook">--</td></tr>
                  <tr><td style="padding: 4px 0; color: #888;">Invert Colors</td><td style="text-align: right;" id="sumInvert">--</td></tr>
                  <tr><td style="padding: 4px 0; color: #888;">Sleep Timer</td><td style="text-align: right;" id="sumSleepTimer">--</td></tr>
                </table>
              </div>
              <div>
                <div style="font-size: 11px; color: #666; margin-bottom: 6px; font-weight: 600;">Reader</div>
                <table style="width: 100%; font-size: 11px;">
                  <tr><td style="padding: 4px 0; color: #888;">Font Size</td><td style="text-align: right;" id="sumFontSize">--</td></tr>
                  <tr><td style="padding: 4px 0; color: #888;">Line Height</td><td style="text-align: right;" id="sumLineHeight">--</td></tr>
                  <tr><td style="padding: 4px 0; color: #888;">Justify Text</td><td style="text-align: right;" id="sumJustify">--</td></tr>
                </table>
              </div>
            </div>
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee; display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div>
                <div style="font-size: 11px; color: #666; margin-bottom: 6px; font-weight: 600;">Sync</div>
                <table style="width: 100%; font-size: 11px;">
                  <tr><td style="padding: 4px 0; color: #888;">KOSync</td><td style="text-align: right;" id="sumKosync">--</td></tr>
                </table>
              </div>
              <div>
                <div style="font-size: 11px; color: #666; margin-bottom: 6px; font-weight: 600;">Keyboard</div>
                <table style="width: 100%; font-size: 11px;">
                  <tr><td style="padding: 4px 0; color: #888;">Bluetooth</td><td style="text-align: right;" id="sumBluetooth">--</td></tr>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Last Updated -->
        <div style="text-align: center; font-size: 11px; color: #999; margin-top: 16px;">
          <span id="sumLastUpdated">Last updated: --</span>
          <button class="btn btn-sm btn-secondary" style="margin-left: 12px;" onclick="refreshSummary()">üîÑ Refresh</button>
        </div>
      </div>

      <!-- ==================== OLD HOME PAGE (hidden, keep for stat IDs) ==================== -->
      <div class="page" id="page-home" style="display:none;">
        <div id="statBattery" style="display:none;">--%</div>
        <div id="statStorage" style="display:none;">--</div>
        <div id="statWifi" style="display:none;">--</div>
        <div id="statUptime" style="display:none;">--</div>
        <div id="infoFirmware" style="display:none;">--</div>
        <div id="infoIP" style="display:none;">--</div>
        <div id="infoMem" style="display:none;">--</div>
      </div>

      <!-- ==================== BUILDER PAGE ==================== -->
      <div class="page" id="page-builder">
        <div class="page-header">
          <h1 class="page-title">Customize Your Sumi</h1>
          <p class="page-desc">Choose your apps, theme, and layout</p>
        </div>
        
        <div class="builder-layout">
          <div class="builder-options">
            <div class="builder-tabs">
              <div class="builder-tab active" onclick="showBuilderTab('apps')">üì± Apps</div>
              <div class="builder-tab" onclick="showBuilderTab('theme')">üé® Theme</div>
              <div class="builder-tab" onclick="showBuilderTab('layout')">üìê Layout</div>
              <div class="builder-tab" onclick="showBuilderTab('sleep')">üò¥ Sleep</div>
            </div>
            
            <!-- APPS TAB -->
            <div class="builder-panel active" id="panel-apps">
              <p class="text-muted mb-8">Select apps for your home screen:</p>
              
              <div class="plugin-category">
                <h4>Core Apps</h4>
                <div class="plugin-grid" id="plugins-core"></div>
              </div>
              
              <div class="plugin-category">
                <h4>Games</h4>
                <div class="plugin-grid" id="plugins-games"></div>
              </div>
              
              <div class="plugin-category">
                <h4>Tools</h4>
                <div class="plugin-grid" id="plugins-tools"></div>
              </div>
              
              <div class="plugin-category">
                <h4>Widgets</h4>
                <div class="plugin-grid" id="plugins-widgets"></div>
                <div id="wifiWarning" style="display:none;"></div>
              </div>
              
              <div class="plugin-category">
                <h4>System</h4>
                <div class="plugin-grid" id="plugins-system"></div>
              </div>
            </div>
            
            <!-- THEME TAB -->
            <div class="builder-panel" id="panel-theme">
              <div class="option-section">
                <h3>Color Theme</h3>
                <div class="style-options">
                  <div class="style-option selected" onclick="selectTheme(0)">
                    <div class="theme-preview light"></div>
                    <span>Light</span>
                  </div>
                  <div class="style-option" onclick="selectTheme(1)">
                    <div class="theme-preview dark"></div>
                    <span>Dark</span>
                  </div>
                  <div class="style-option" onclick="selectTheme(2)">
                    <div class="theme-preview contrast"></div>
                    <span>Contrast</span>
                  </div>
                </div>
              </div>
              
              <div class="option-section">
                <h3>Icon Style</h3>
                <div class="style-options">
                  <div class="style-option selected" onclick="selectIconStyle('rounded')">
                    <div class="icon-preview rounded">A</div>
                    <span>Rounded</span>
                  </div>
                  <div class="style-option" onclick="selectIconStyle('square')">
                    <div class="icon-preview square">A</div>
                    <span>Square</span>
                  </div>
                  <div class="style-option" onclick="selectIconStyle('circle')">
                    <div class="icon-preview circle">A</div>
                    <span>Circle</span>
                  </div>
                </div>
              </div>
              
              <div class="option-section">
                <h3>Font Size</h3>
                <div class="slider-row">
                  <label>Label Size:</label>
                  <input type="range" id="fontSizeSlider" min="10" max="18" value="12" oninput="updateFontSize(this.value)">
                  <span class="value" id="fontSizeVal">12px</span>
                </div>
              </div>
            </div>
            
            <!-- LAYOUT TAB -->
            <div class="builder-panel" id="panel-layout">
              <div class="option-section">
                <h3>Orientation</h3>
                <div class="style-options" style="grid-template-columns: repeat(2, 1fr);">
                  <div class="style-option" onclick="selectOrientation('landscape')">
                    <div class="orient-preview" style="width:40px;height:24px;"></div>
                    <span>Landscape</span>
                  </div>
                  <div class="style-option selected" onclick="selectOrientation('portrait')">
                    <div class="orient-preview" style="width:24px;height:40px;"></div>
                    <span>Portrait</span>
                  </div>
                </div>
              </div>
              
              <div class="option-section">
                <h3>Status Bar</h3>
                <div class="toggle"><span class="toggle-label">Show Status Bar</span><div class="toggle-switch on" id="togStatusBar" onclick="toggleBuilder(this,'showStatusBar')"></div></div>
                <div class="toggle"><span class="toggle-label">Show Battery</span><div class="toggle-switch on" id="togBattery" onclick="toggleBuilder(this,'showBattery')"></div></div>
                <div class="toggle"><span class="toggle-label">Show Clock</span><div class="toggle-switch on" id="togClock" onclick="toggleBuilder(this,'showClock')"></div></div>
                <div class="toggle"><span class="toggle-label">Show WiFi</span><div class="toggle-switch" id="togWifi" onclick="toggleBuilder(this,'showWifi')"></div></div>
              </div>
            </div>
            
            <!-- SLEEP SCREEN TAB -->
            <div class="builder-panel" id="panel-sleep">
              <div class="option-section">
                <h3>Sleep Display</h3>
                <div class="style-options">
                  <div class="style-option" onclick="selectSleepStyle('book')">
                    <div style="font-size:18px;">üìï</div>
                    <span>Book Cover</span>
                  </div>
                  <div class="style-option" onclick="selectSleepStyle('shuffle')">
                    <div style="font-size:18px;">üîÄ</div>
                    <span>Shuffle</span>
                  </div>
                  <div class="style-option selected" onclick="selectSleepStyle('off')">
                    <div style="font-size:18px;">üí§</div>
                    <span>Wake Me</span>
                  </div>
                </div>
              </div>
              
              <div class="option-section">
                <h3>Sleep Options</h3>
                <div class="toggle"><span class="toggle-label">Show Battery Warning</span><div class="toggle-switch on" id="togSleepBattery" onclick="toggleBuilder(this,'showBatterySleep')"></div></div>
              </div>
              
              <div class="option-section">
                <h3>Wake Button</h3>
                <select id="wakeButton" onchange="builderConfig.wakeButton=this.value" style="width:100%;">
                  <option value="any">Any Button</option>
                  <option value="select">Select Button Only</option>
                  <option value="power">Power Button Only</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- PREVIEW -->
          <div class="builder-preview">
            <div class="preview-header">
              <span>üì± Live Preview</span>
              <span class="preview-badge" id="previewBadge">Home</span>
            </div>
            <div class="preview-tabs">
              <div class="preview-tab active" onclick="setPreviewMode('home')">üè† Home</div>
              <div class="preview-tab" onclick="setPreviewMode('sleep')">üò¥ Sleep</div>
            </div>
            <div class="device-container">
              <div class="device-outer portrait" id="deviceFrame">
                <div class="device-inner">
                  <div class="eink-screen light" id="einkScreen"></div>
                </div>
              </div>
            </div>
            <div style="text-align:center;margin-top:8px;">
              <button class="btn btn-sm" onclick="togglePreviewOrientation()">üîÑ Rotate</button>
            </div>
            <div id="previewStats" style="margin-top:6px;text-align:center;font-size:9px;color:var(--mac-gray-dark)"></div>
          </div>
        </div>
      </div>

      <!-- ==================== WIFI PAGE ==================== -->
      <div class="page active" id="page-wifi">
        <div class="page-header">
          <h1 class="page-title">WiFi Settings</h1>
          <p class="page-desc">Connect to your home network</p>
        </div>
        
        <!-- Important info banner -->
        <div class="card" style="background: linear-gradient(135deg, #e3f2fd 0%, #e8f5e9 100%); border: 1px solid #90caf9; margin-bottom: 12px;">
          <div class="card-body" style="padding: 12px;">
            <div style="display: flex; align-items: flex-start; gap: 10px;">
              <div style="font-size: 24px;">üí°</div>
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 13px; margin-bottom: 6px;">Why Connect to WiFi?</div>
                <div style="font-size: 11px; color: #555; line-height: 1.5;">
                  Internet access enables: <strong>Weather updates</strong>, <strong>time sync</strong>, <strong>KOSync reading progress</strong>, and <strong>EPUB pre-processing</strong> (extracts chapters and covers for instant book loading).
                </div>
                <div style="font-size: 11px; color: #666; line-height: 1.5; margin-top: 8px; padding-top: 8px; border-top: 1px solid #ccc;">
                  <strong>Steps:</strong> Enter your WiFi credentials below ‚Üí After SUMI connects, switch your phone/laptop to the same WiFi ‚Üí Access portal at the new IP address shown
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <span class="card-title">Current Connection</span>
          </div>
          <div class="card-body">
            <div id="wifiStatus">Checking...</div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <span class="card-title">Available Networks</span>
            <button class="btn btn-sm btn-secondary" onclick="scanWifi()" id="wifiScanBtn">üîç Scan</button>
          </div>
          <div class="card-body" style="padding:0;">
            <div id="wifiList" class="list-view" style="min-height:100px;border:none;">
              <div style="padding:20px;text-align:center;color:var(--mac-gray-dark);">Click Scan to find networks</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== FILES PAGE ==================== -->
      <div class="page" id="page-files">
        <div class="page-header">
          <h1 class="page-title">File Manager</h1>
          <p class="page-desc">Manage your books, images, and more</p>
        </div>
        
        <div class="file-tabs">
          <div class="file-tab active" onclick="showFileTab('books')">üìö Books <span class="count" id="countBooks">0</span></div>
          <div class="file-tab" onclick="showFileTab('images')">üñºÔ∏è Images <span class="count" id="countImages">0</span></div>
          <div class="file-tab" onclick="showFileTab('maps')">üó∫Ô∏è Maps <span class="count" id="countMaps">0</span></div>
          <div class="file-tab" onclick="showFileTab('flashcards')">üé¥ Cards <span class="count" id="countFlashcards">0</span></div>
          <div class="file-tab" onclick="showFileTab('notes')">üìù Notes <span class="count" id="countNotes">0</span></div>
        </div>
        
        <!-- Books Panel -->
        <div class="file-panel active" id="panel-books">
          <!-- Cover Processing Info Card -->
          <div class="card" style="background: linear-gradient(135deg, #e8f4fd 0%, #f0e6ff 100%); border: 1px solid #b8d4e8; margin-bottom: 12px;">
            <div class="card-body" style="padding: 12px;">
              <div style="display: flex; align-items: flex-start; gap: 10px;">
                <div style="font-size: 24px;">üöÄ</div>
                <div style="flex: 1;">
                  <div style="font-weight: 600; font-size: 13px; margin-bottom: 4px;">Smart Book Processing</div>
                  <div style="font-size: 11px; color: #555; line-height: 1.4;">
                    When you upload EPUBs, your browser pre-processes everything: extracts chapters as plain text, 
                    optimizes cover art, and creates a ready-to-read cache. SUMI loads books instantly with zero processing!
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Dynamic warning for unprocessed books (populated by JS) -->
          <div id="coverWarning"></div>
          
          <!-- Lightbulb tip for processing (populated by JS when on home network) -->
          <div id="processingTip" style="display: none;"></div>
          
          <div class="upload-zone" id="bookUploadZone" onclick="this.querySelector('input').click()" ondragover="event.preventDefault();this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')" ondrop="handleBookDrop(event)">
            <div class="icon">üìö</div>
            <div class="text">Drop books here or click to upload</div>
            <div class="hint">Supports: EPUB (with automatic cover extraction)</div>
            <input type="file" accept=".epub,.pdf,.txt" multiple onchange="uploadBooks(this.files)">
          </div>
          
          <!-- Upload Progress (hidden by default) -->
          <div id="uploadProgress" style="display: none; margin-bottom: 12px;">
            <div class="card">
              <div class="card-body" style="padding: 12px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                  <div class="spinner" style="width: 20px; height: 20px; border: 2px solid #ddd; border-top-color: #007aff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                  <div id="uploadStatusText" style="font-size: 12px; font-weight: 500;">Processing...</div>
                </div>
                <div class="progress" style="height: 6px; margin-bottom: 6px;">
                  <div class="progress-bar" id="uploadProgressBar" style="width: 0%; transition: width 0.3s;"></div>
                </div>
                <div id="uploadDetailText" style="font-size: 10px; color: #888;"></div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <span class="card-title">Your Books</span>
              <button class="btn btn-sm btn-secondary" onclick="refreshFiles('books')">üîÑ</button>
            </div>
            <div class="card-body">
              <div class="file-grid" id="bookGrid">
                <div class="file-empty"><div class="icon">üìö</div><div>No books yet</div></div>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><span class="card-title">Reader Settings</span></div>
            <div class="card-body">
              <div style="display:grid;grid-template-columns:1fr 180px;gap:12px;">
                <div>
                  <div class="slider-row">
                    <span class="slider-label">Font Size</span>
                    <input type="range" class="slider-input" id="readerFontSize" min="12" max="32" value="18" oninput="updateReaderPreview()">
                    <span class="slider-value" id="readerFontVal">18px</span>
                  </div>
                  <div class="slider-row">
                    <span class="slider-label">Line Height</span>
                    <input type="range" class="slider-input" id="readerLineHeight" min="100" max="200" step="10" value="150" oninput="updateReaderPreview()">
                    <span class="slider-value" id="readerLineVal">150%</span>
                  </div>
                  <div class="slider-row">
                    <span class="slider-label">Margins</span>
                    <input type="range" class="slider-input" id="readerMargins" min="5" max="40" value="20" oninput="updateReaderPreview()">
                    <span class="slider-value" id="readerMarginVal">20px</span>
                  </div>
                  <div class="toggle">
                    <span class="toggle-label">Justify Text</span>
                    <div class="toggle-switch on" id="togJustify" onclick="toggleReaderOpt(this,'textAlign');updateReaderPreview()"></div>
                  </div>
                  <div class="toggle" style="margin-top:8px;">
                    <span class="toggle-label">Require Pre-processing</span>
                    <div class="toggle-switch on" id="togReqPreprocess" onclick="toggleReaderOpt(this,'requirePreprocessed')" title="Books must be processed via portal to open (recommended)"></div>
                  </div>
                </div>
                <div>
                  <div style="font-size:9px;font-weight:bold;margin-bottom:4px;color:var(--mac-gray-dark);">Preview</div>
                  <div id="readerPreview" style="background:#f5f5f0;border:1px solid var(--mac-black);height:140px;overflow:hidden;padding:8px;font-family:Georgia,serif;">
                    <p style="margin:0;">It was the best of times, it was the worst of times, it was the age of wisdom, it was the age of foolishness...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Images Panel -->
        <div class="file-panel" id="panel-images">
          <!-- Info box -->
          <div style="background: #e8f4fd; border: 1px solid #bee5eb; border-radius: 8px; padding: 12px 14px; margin-bottom: 12px;">
            <div style="display: flex; align-items: flex-start; gap: 10px;">
              <div style="font-size: 16px;">üí°</div>
              <div style="flex: 1; font-size: 11px; color: #0c5460; line-height: 1.5;">
                <strong>Image Tips:</strong><br>
                ‚Ä¢ <strong>Format:</strong> BMP files (1-bit monochrome or 24-bit color)<br>
                ‚Ä¢ <strong>Processing:</strong> Color images auto-convert to grayscale with dithering<br>
                ‚Ä¢ <strong>Size:</strong> Images are scaled to fit the 800√ó480 e-ink display<br>
                ‚Ä¢ <strong>Sleep Screen:</strong> Enable "Shuffle Images" in Settings to use as a rotating sleep screen slideshow
              </div>
            </div>
          </div>
          
          <div class="upload-zone" onclick="this.querySelector('input').click()" ondragover="event.preventDefault();this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')" ondrop="handleDrop(event,'images')">
            <div class="icon">üñºÔ∏è</div>
            <div class="text">Drop images here</div>
            <div class="hint">Supports: BMP (1-bit or 24-bit)</div>
            <input type="file" accept=".bmp" multiple onchange="uploadFiles(this.files,'images')">
          </div>
          <div class="card">
            <div class="card-header"><span class="card-title">Your Images</span><button class="btn btn-sm btn-secondary" onclick="refreshFiles('images')">üîÑ</button></div>
            <div class="card-body">
              <div class="file-grid" id="imageGrid">
                <div class="file-empty"><div class="icon">üñºÔ∏è</div><div>No images yet</div></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Maps Panel -->
        <div class="file-panel" id="panel-maps">
          <div class="upload-zone" onclick="this.querySelector('input').click()" ondragover="event.preventDefault();this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')" ondrop="handleDrop(event,'maps')">
            <div class="icon">üó∫Ô∏è</div>
            <div class="text">Drop map images here</div>
            <div class="hint">Supports: PNG, BMP, JPG</div>
            <input type="file" accept=".png,.bmp,.jpg,.jpeg" multiple onchange="uploadFiles(this.files,'maps')">
          </div>
          <div class="card">
            <div class="card-header"><span class="card-title">Your Maps</span><button class="btn btn-sm btn-secondary" onclick="refreshFiles('maps')">üîÑ</button></div>
            <div class="card-body">
              <div class="file-grid" id="mapGrid">
                <div class="file-empty"><div class="icon">üó∫Ô∏è</div><div>No maps yet</div></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Flashcards Panel -->
        <div class="file-panel" id="panel-flashcards">
          <div class="btn-group mb-8">
            <button class="btn btn-primary" onclick="showCreateDeckModal()">‚ûï Create Deck</button>
            <button class="btn btn-secondary" onclick="document.getElementById('ankiImport').click()">üì• Import</button>
            <input type="file" id="ankiImport" accept=".txt,.csv,.apkg" style="display:none" onchange="importAnkiDeck(this.files[0])">
          </div>
          
          <!-- Info box -->
          <div style="background: #e8f4fd; border: 1px solid #bee5eb; border-radius: 8px; padding: 12px 14px; margin-bottom: 12px;">
            <div style="display: flex; align-items: flex-start; gap: 10px;">
              <div style="font-size: 16px;">üí°</div>
              <div style="flex: 1; font-size: 11px; color: #0c5460; line-height: 1.5;">
                <strong>Supported Formats:</strong><br>
                ‚Ä¢ <strong>CSV/TSV (recommended):</strong> <code>question,answer</code> or <code>term‚á•definition</code> ‚Äî works with Quizlet & Anki exports<br>
                ‚Ä¢ <strong>TXT:</strong> Alternating lines (question on one line, answer on next) or <code>question;answer</code> per line<br>
                ‚Ä¢ <strong>JSON:</strong> Array of objects with field pairs: front/back, question/answer, term/definition, word/meaning, or kanji/reading
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header"><span class="card-title">Your Decks</span><button class="btn btn-sm btn-secondary" onclick="refreshFiles('flashcards')">üîÑ</button></div>
            <div class="card-body">
              <div id="deckList">
                <div class="file-empty"><div class="icon">üé¥</div><div>No decks yet</div></div>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><span class="card-title">Flashcard Settings</span></div>
            <div class="card-body">
              <div style="display:grid;grid-template-columns:1fr 180px;gap:12px;">
                <div>
                  <div class="slider-row">
                    <span class="slider-label">Font Size</span>
                    <select id="fcFontSize" onchange="updateFlashcardPreview();saveFlashcardSettings()">
                      <option value="0">Small</option>
                      <option value="1" selected>Medium</option>
                      <option value="2">Large</option>
                      <option value="3">Extra Large</option>
                    </select>
                  </div>
                  <div class="toggle">
                    <span class="toggle-label">Center Text</span>
                    <div class="toggle-switch on" id="togFcCenter" onclick="toggleSwitchSimple(this);updateFlashcardPreview();saveFlashcardSettings()"></div>
                  </div>
                  <div class="toggle" style="margin-top:8px;">
                    <span class="toggle-label">Shuffle Cards</span>
                    <div class="toggle-switch on" id="togFcShuffle" onclick="toggleSwitchSimple(this);saveFlashcardSettings()"></div>
                  </div>
                  <div class="toggle" style="margin-top:8px;">
                    <span class="toggle-label">Show Progress Bar</span>
                    <div class="toggle-switch on" id="togFcProgress" onclick="toggleSwitchSimple(this);updateFlashcardPreview();saveFlashcardSettings()"></div>
                  </div>
                  <div class="toggle" style="margin-top:8px;">
                    <span class="toggle-label">Show Stats</span>
                    <div class="toggle-switch on" id="togFcStats" onclick="toggleSwitchSimple(this);updateFlashcardPreview();saveFlashcardSettings()"></div>
                  </div>
                </div>
                <div>
                  <div style="font-size:9px;font-weight:bold;margin-bottom:4px;color:var(--mac-gray-dark);">Preview</div>
                  <div id="flashcardPreview" style="background:#f5f5f0;border:1px solid var(--mac-black);height:200px;overflow:hidden;font-family:sans-serif;position:relative;">
                    <!-- Progress bar -->
                    <div id="fcPreviewProgress" style="height:6px;background:#ddd;margin:6px 8px;">
                      <div style="width:40%;height:100%;background:#333;"></div>
                    </div>
                    <div style="font-size:8px;padding:0 8px;color:#666;">Card 2 of 5</div>
                    <div style="border-top:1px solid #333;margin:4px 0;"></div>
                    <!-- Question area -->
                    <div id="fcPreviewQuestion" style="padding:4px 8px;">
                      <div style="font-size:8px;color:#666;margin-bottom:2px;">Question:</div>
                      <div id="fcPreviewQText" style="font-size:14px;font-weight:bold;">What is 2 + 2?</div>
                    </div>
                    <div style="border-top:1px solid #333;margin:4px 8px;"></div>
                    <!-- Answer area -->
                    <div id="fcPreviewAnswer" style="padding:4px 8px;">
                      <div style="font-size:8px;color:#666;margin-bottom:2px;">Answer:</div>
                      <div id="fcPreviewAText" style="font-size:14px;font-weight:bold;">4</div>
                    </div>
                    <!-- Footer -->
                    <div style="position:absolute;bottom:0;left:0;right:0;border-top:1px solid #333;padding:4px 8px;background:#f5f5f0;display:flex;justify-content:space-between;font-size:8px;">
                      <span id="fcPreviewStats">2/0</span>
                      <span>&lt;Wrong  Right&gt;</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Notes Panel -->
        <div class="file-panel" id="panel-notes">
          <div class="btn-group mb-8">
            <button class="btn btn-primary" onclick="createNewNote()">üìù New Note</button>
          </div>
          <div class="card">
            <div class="card-header"><span class="card-title">Your Notes</span><button class="btn btn-sm btn-secondary" onclick="refreshFiles('notes')">üîÑ</button></div>
            <div class="card-body">
              <div class="file-grid" id="noteGrid">
                <div class="file-empty"><div class="icon">üìù</div><div>No notes yet</div></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== WEATHER PAGE ==================== -->
      <div class="page" id="page-weather">
        <div class="page-header">
          <h1 class="page-title">Weather Settings</h1>
          <p class="page-desc">Configure weather display</p>
        </div>
        
        <div class="card">
          <div class="card-header"><span class="card-title">Location</span></div>
          <div class="card-body">
            <div id="weatherLocation" class="mb-8 text-muted">Auto-detected from IP</div>
            <div class="form-row">
              <label>ZIP Code:</label>
              <input type="text" class="text-input" id="weatherZip" placeholder="e.g. 80424" style="width:80px;">
              <button class="btn btn-sm" onclick="saveWeatherZip()">Set</button>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header"><span class="card-title">Timezone</span></div>
          <div class="card-body">
            <select id="timezoneSelect" style="width:100%;" onchange="saveTimezone()">
              <option value="auto">Auto-detect from IP</option>
              <option value="-18000">Eastern (UTC-5)</option>
              <option value="-21600">Central (UTC-6)</option>
              <option value="-25200">Mountain (UTC-7)</option>
              <option value="-28800">Pacific (UTC-8)</option>
              <option value="0">UTC</option>
            </select>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header"><span class="card-title">Units</span></div>
          <div class="card-body">
            <div class="toggle">
              <span class="toggle-label">Use Celsius (¬∞C)</span>
              <div class="toggle-switch" id="togCelsius" onclick="toggleOpt(this,'useCelsius')"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== DISPLAY PAGE ==================== -->
      <div class="page" id="page-display">
        <div class="page-header">
          <h1 class="page-title">Display Settings</h1>
          <p class="page-desc">Configure your e-ink display</p>
        </div>
        
        <div class="card">
          <div class="card-header"><span class="card-title">Display Options</span></div>
          <div class="card-body">
            <div class="toggle">
              <div><span class="toggle-label">Landscape Mode</span><div class="toggle-desc">Rotate display 90¬∞</div></div>
              <div class="toggle-switch" id="togLandscape" onclick="toggleOpt(this,'landscape')"></div>
            </div>
            <div class="toggle">
              <div><span class="toggle-label">Invert Colors</span><div class="toggle-desc">Dark background, light text</div></div>
              <div class="toggle-switch" id="togInvert" onclick="toggleOpt(this,'invertColors')"></div>
            </div>
            <div class="toggle">
              <div><span class="toggle-label">Boot to Last Book</span><div class="toggle-desc">Resume reading on startup</div></div>
              <div class="toggle-switch" id="togBootToBook" onclick="toggleOpt(this,'bootToLastBook')"></div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header"><span class="card-title">Auto-Sleep</span></div>
          <div class="card-body">
            <div class="slider-row">
              <span class="slider-label">Sleep after:</span>
              <input type="range" class="slider-input" id="sleepSlider" min="5" max="60" step="5" value="15" oninput="updateSlider(this,'sleepVal',' min')">
              <span class="slider-value" id="sleepVal">15 min</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== BLUETOOTH PAGE ==================== -->
      <div class="page" id="page-bluetooth">
        <div class="page-header">
          <h1 class="page-title">Keyboard Settings</h1>
          <p class="page-desc">Connect Bluetooth keyboards and page turners</p>
        </div>
        
        <div class="card">
          <div class="card-header"><span class="card-title">Bluetooth</span></div>
          <div class="card-body">
            <div class="toggle">
              <div><span class="toggle-label">Enable Bluetooth</span><div class="toggle-desc">Allow BT connections</div></div>
              <div class="toggle-switch" id="togBTEnabled" onclick="toggleBT(this)"></div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header"><span class="card-title">Paired Devices</span></div>
          <div class="card-body" id="btPaired">
            <div class="text-center text-muted">No devices paired yet</div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <span class="card-title">Available Devices</span>
            <button class="btn btn-sm btn-secondary" id="btScanBtn" onclick="scanBT()">üîç Scan</button>
          </div>
          <div class="card-body" id="btDiscovered">
            <div class="text-center text-muted">Click Scan to search</div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header"><span class="card-title">Keyboard Layout</span></div>
          <div class="card-body">
            <select id="kbLayout" style="width:100%;">
              <option>US English (QWERTY)</option>
              <option>UK English</option>
              <option>German (QWERTZ)</option>
              <option>French (AZERTY)</option>
            </select>
          </div>
        </div>
      </div>

      <!-- ==================== POWER PAGE ==================== -->
      <div class="page" id="page-power">
        <div class="page-header">
          <h1 class="page-title">Power</h1>
          <p class="page-desc">Battery status and power settings</p>
        </div>
        
        <div class="card">
          <div class="card-header"><span class="card-title">Battery Status</span></div>
          <div class="card-body text-center">
            <div style="font-size:48px;">üîã</div>
            <div style="font-size:28px;font-weight:bold;" id="powerPercent">--%</div>
            <div class="text-muted" id="powerVolts">-- V</div>
            <div class="progress" style="margin-top:12px;">
              <div class="progress-bar" id="powerBar" style="width:0%;"></div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header"><span class="card-title">Power Settings</span></div>
          <div class="card-body">
            <div class="toggle">
              <div><span class="toggle-label">Deep Sleep Mode</span><div class="toggle-desc">Lower power consumption when sleeping</div></div>
              <div class="toggle-switch on" id="togDeepSleep" onclick="toggleOpt(this,'deepSleep')"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== ABOUT PAGE ==================== -->
      <div class="page" id="page-about">
        <div class="page-header">
          <h1 class="page-title">About</h1>
          <p class="page-desc">Device information and system tools</p>
        </div>
        
        <div class="card">
          <div class="card-header"><span class="card-title">Device Information</span></div>
          <div class="card-body">
            <table style="width:100%;font-size:11px;">
              <tr><td class="text-muted" style="padding:4px 0">Firmware</td><td style="text-align:right" id="aboutFirmware">--</td></tr>
              <tr><td class="text-muted" style="padding:4px 0">Hardware</td><td style="text-align:right">ESP32-C3</td></tr>
              <tr><td class="text-muted" style="padding:4px 0">Display</td><td style="text-align:right">GDEQ0426T82 4.26"</td></tr>
              <tr><td class="text-muted" style="padding:4px 0">Resolution</td><td style="text-align:right">800√ó480</td></tr>
              <tr><td class="text-muted" style="padding:4px 0">SD Card</td><td style="text-align:right" id="aboutSD">--</td></tr>
              <tr><td class="text-muted" style="padding:4px 0">Free Memory</td><td style="text-align:right" id="aboutMem">--</td></tr>
              <tr><td class="text-muted" style="padding:4px 0">Uptime</td><td style="text-align:right" id="aboutUptime">--</td></tr>
            </table>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header"><span class="card-title">System Actions</span></div>
          <div class="card-body">
            <div class="btn-group">
              <button class="btn btn-secondary" onclick="refreshDisplay()">üîÑ Refresh Display</button>
              <button class="btn btn-secondary" onclick="rebootDevice()">üîÉ Reboot</button>
              <button class="btn btn-danger" onclick="factoryReset()">üóëÔ∏è Factory Reset</button>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header"><span class="card-title">Backup & Restore</span></div>
          <div class="card-body">
            <div class="btn-group">
              <button class="btn btn-secondary" onclick="downloadBackup()">üì• Download Backup</button>
              <button class="btn btn-secondary" onclick="document.getElementById('restoreFile').click()">üì§ Restore</button>
              <input type="file" id="restoreFile" accept=".json" style="display:none" onchange="restoreBackup(this.files[0])">
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <!-- Action Bar (inside window) -->
  <div class="action-bar">
    <button class="btn btn-secondary" onclick="resetToDefaults()">‚Ü©Ô∏è Reset</button>
    <button class="btn btn-primary" id="deployBtn" onclick="saveAndDeploy()">üíæ Save & Deploy</button>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- WiFi Modal -->
<div class="modal" id="wifiModal">
  <div class="modal-content">
    <div class="modal-header">Connect to WiFi</div>
    <div class="modal-body">
      <p class="mb-8">Network: <strong id="wifiModalSSID"></strong></p>
      <div class="input-row">
        <label>Password:</label>
        <input type="password" class="text-input" id="wifiPassword" style="flex:1;" onkeypress="if(event.key==='Enter')connectWifi()">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('wifiModal')">Cancel</button>
      <button class="btn btn-primary" onclick="connectWifi()">Connect</button>
    </div>
  </div>
</div>
